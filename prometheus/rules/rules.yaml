groups:
  - name: White box monitoring
    rules:
      - alert: ç³»ç»ŸçŠ¶æ€
        expr: up == 0
        for: 30s
        labels:
          severity: è­¦å‘Š
        annotations:
          summary: "ğŸ“ç³»ç»Ÿ {{ $labels.job }} å…³é—­"
          description: "ç³»ç»Ÿ {{ $labels.job }} å®ä¾‹å…³é—­"
          ip: "{{ $labels.ip }}"
          value: "up{ job={{ $labels.job}} } == 0"

      - alert: Pod-é‡å¯
        expr: changes(kube_pod_container_status_restarts_total{pod !~ "analyzer.*"}[3m]) > 0
        for: 30s
        labels:
          severity: è­¦å‘Š
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster}}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“{{ $labels.pod }} Restart"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          pod: "{{ $labels.pod }}"
          container: "{{ $labels.container }}"
          value: 'changes(kube_pod_container_status_restarts_total{pod !~ "analyzer.*"}[3m]) > 0'

      - alert: Pod-æœªçŸ¥é”™è¯¯/å¤±è´¥
        expr: kube_pod_status_phase{phase="Unknown"} == 1 or kube_pod_status_phase{phase="Failed"} == 1
        for: 1m
        labels:
          severity: ç´§æ€¥
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“Pod: {{ $labels.pod }} æœªçŸ¥é”™è¯¯/å¤±è´¥"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          pod: "{{ $labels.pod }}"
          container: "{{ $labels.container }}"
          value: 'kube_pod_status_phase{phase="Unknown"} == 1 or kube_pod_status_phase{phase="Failed"} == 1'

      - alert: Job-å¤±è´¥
        expr: kube_job_status_failed == 1
        for: 3m
        labels:
          severity: è­¦å‘Š
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“Job: {{ $labels.job_name }} Failed"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          job: "{{ $labels.job_name }}"
          value: "kube_job_status_failed == 1"

      - alert: Pod NotReady
        expr: sum by (namespace, pod, cluster_id) (max by(namespace, pod, cluster_id)(kube_pod_status_phase{namespace=~"(easm|bas)",phase=~"Pending|Unknown"}) * on(namespace, pod, cluster_id)group_left(owner_kind) topk by(namespace, pod) (1, max by(namespace, pod,owner_kind, cluster_id) (kube_pod_owner{owner_kind!="Job"}))) > 0
        for: 3m
        labels:
          severity: è­¦å‘Š
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“pod: {{ $labels.pod }} å¤„äº NotReady çŠ¶æ€è¶…è¿‡15åˆ†é’Ÿ"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          value: 'sum by (namespace, pod, cluster_id) (max by(namespace, pod, cluster_id)(kube_pod_status_phase{namespace=~"(easm|bas)",phase=~"Pending|Unknown"}) * on(namespace, pod, cluster_id)group_left(owner_kind) topk by(namespace, pod) (1, max by(namespace, pod,owner_kind, cluster_id) (kube_pod_owner{owner_kind!="Job"}))) > 0'

      - alert: Deploymentå‰¯æœ¬æ•°
        expr: (kube_deployment_spec_replicas != kube_deployment_status_replicas_available) and (changes(kube_deployment_status_replicas_updated[5m]) == 0)
        for: 3m
        labels:
          severity: è­¦å‘Š
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“Deployment: {{ $labels.deployment }} å®é™…å‰¯æœ¬æ•°å’Œè®¾ç½®å‰¯æœ¬æ•°ä¸ä¸€è‡´"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          deployment: "{{ $labels.deployment }}"
          value: '(kube_deployment_spec_replicas != kube_deployment_status_replicas_available) and (changes(kube_deployment_status_replicas_updated[5m]) == 0)'

      - alert: Statefulsetå‰¯æœ¬æ•°
        expr: (kube_statefulset_status_replicas_ready != kube_statefulset_status_replicas) and (changes(kube_statefulset_status_replicas_updated[5m]) == 0)
        for: 3m
        labels:
          severity: è­¦å‘Š
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“Statefulset: {{ $labels.statefulset }} å®é™…å‰¯æœ¬æ•°å’Œè®¾ç½®å‰¯æœ¬æ•°ä¸ä¸€è‡´"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          statefulset: "{{ $labels.statefulset }}"
          value: '(kube_statefulset_status_replicas_ready != kube_statefulset_status_replicas) and (changes(kube_statefulset_status_replicas_updated[5m]) == 0)'

      - alert: å­˜å‚¨å·PV
        expr: kube_persistentvolume_status_phase{phase=~"Failed|Pending"} > 0
        for: 2m
        labels:
          severity: ç´§æ€¥
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“å­˜å‚¨å·PV: {{ $labels.persistentvolume }} å¤„äºFailedæˆ–PendingçŠ¶æ€"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          persistentvolume: "{{ $labels.persistentvolume }}"
          value: 'kube_persistentvolume_status_phase{phase=~"Failed|Pending"} > 0'

      - alert: å­˜å‚¨å·PVC
        expr: kube_persistentvolumeclaim_status_phase{phase=~"Failed|Pending|Lost"} > 0
        for: 2m
        labels:
          severity: ç´§æ€¥
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“å­˜å‚¨å·PVC: {{ $labels.persistentvolumeclaim }} Failedæˆ–PendingçŠ¶æ€"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          persistentvolumeclaim: "{{ $labels.persistentvolumeclaim }}"
          value: 'kube_persistentvolumeclaim_status_phase{phase=~"Failed|Pending|Lost"} > 0'

      - alert: k8s service
        expr: kube_service_status_load_balancer_ingress != 1
        for: 2m
        labels:
          severity: ç´§æ€¥
          service: prometheus_bot
          receiver_group: "{{ $labels.k8scluster }}_{{ $labels.namespace }}"
        annotations:
          summary: "ğŸ“Service: {{ $labels.service }} æœåŠ¡è´Ÿè½½å‡è¡¡å™¨å…¥å£çŠ¶æ€DOWNï¼"
          k8scluster: "{{ $labels.k8scluster }}"
          namespace: "{{ $labels.namespace }}"
          persistentvolumeclaim: "{{ $labels.service }}"
          value: 'kube_service_status_load_balancer_ingress != 1'

      - alert: ç£ç›˜IOæ€§èƒ½
        expr: 100-(avg(irate(node_disk_io_time_seconds_total[1m])) by(instance)* 100) < 60
        for: 3m
        labels:
          severity: è­¦å‘Š
        annotations:
          summary: "ğŸ“{{$labels.mountpoint }} æµå…¥ç£ç›˜IOä½¿ç”¨ç‡è¿‡é«˜ï¼"
          description: "{{$labels.mountpoint }} æµå…¥ç£ç›˜IOå¤§äº60%(ç›®å‰ä½¿ç”¨:{{$value}})"

      - alert: ç½‘ç»œæµå…¥
        expr: ((sum(rate (node_network_receive_bytes_total{device!~'tap.*|veth.*|br.*|docker.*|virbr*|lo*'}[5m])) by (instance)) / 100) > 102400
        for: 3m
        labels:
          severity: è­¦å‘Š
        annotations:
          summary: "ğŸ“{{$labels.mountpoint }} æµå…¥ç½‘ç»œå¸¦å®½è¿‡é«˜ï¼"
          description: "{{$labels.mountpoint }}æµå…¥ç½‘ç»œå¸¦å®½æŒç»­2åˆ†é’Ÿé«˜äº100M. RXå¸¦å®½ä½¿ç”¨ç‡{{$value}}"

      - alert: ç½‘ç»œæµå‡º
        expr: ((sum(rate (node_network_transmit_bytes_total{device!~'tap.*|veth.*|br.*|docker.*|virbr*|lo*'}[5m])) by (instance)) / 100) > 102400
        for: 3m
        labels:
          severity: è­¦å‘Š
        annotations:
          summary: "ğŸ“{{$labels.mountpoint }} æµå‡ºç½‘ç»œå¸¦å®½è¿‡é«˜ï¼"
          description: "{{$labels.mountpoint }}æµå‡ºç½‘ç»œå¸¦å®½æŒç»­2åˆ†é’Ÿé«˜äº100M. RXå¸¦å®½ä½¿ç”¨ç‡{{$value}}"

      - alert: ç£ç›˜å®¹é‡
        expr: 100-(node_filesystem_free_bytes{fstype=~"ext4|xfs"}/node_filesystem_size_bytes {fstype=~"ext4|xfs"}*100) > 80
        for: 1m
        labels:
          severity: ç´§æ€¥
        annotations:
          summary: "ğŸ“{{$labels.mountpoint }} ç£ç›˜åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ï¼"
          description: "{{$labels.mountpoint }} ç£ç›˜åˆ†åŒºä½¿ç”¨å¤§äº80%(ç›®å‰ä½¿ç”¨:{{$value}}%)"